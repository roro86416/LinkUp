generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- 模組三：相關的枚舉 (Enums) ---

// 訂單狀態 (來自 Order 表)
enum OrderStatus {
  pending   // 待付款
  paid      // 已付款
  shipped   // (商品) 已出貨
  completed // (流程) 已完成
  cancelled // 已取消
}

// 項目類型 (來自 CartItem / OrderItem 表)
enum ItemType {
  ticket_types // 票券
  products     // 商品
}

// (商品) 運送方式 (來自 OrderItem 表)
enum DeliveryMethod {
  shipping       // 宅配
  on_site_pickup // 現場取貨
}


// --- 1. 商城 (Products) ---
// 商品
model Product {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255) /// 商品名稱
  description String?  @db.Text /// 商品描述
  base_price  Decimal  @db.Decimal(10, 2) /// 商品基本價格
  image_url   String?  @db.VarChar(255) /// 商品圖片
  is_published Boolean  @default(false)
  // 關聯：一個商品有多個規格
  variants ProductVariant[]
  
  // 關聯：活動-商品 多對多
  events_products EventsProducts[]
  
  @@map("products") // 對應 CSV 表名
}

// 商品規格
model ProductVariant {
  id             Int     @id @default(autoincrement()) /// 規格 ID
  product_id     Int
  product        Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  sku            String? @unique @db.VarChar(100)
  option1_name   String? @db.VarChar(50)
  option1_value  String? @db.VarChar(50)
  option2_name   String? @db.VarChar(50)
  option2_value  String? @db.VarChar(50)
  price_offset   Decimal @default(0) @db.Decimal(10, 2)
  stock_quantity Int     @default(0) @map("stock") // CSV 中欄位名為 stock
  // 關聯：此規格在哪些購物車項目中
  cart_items CartItem[]
  // 關聯：此規格在哪些訂單項目中
  order_items OrderItem[]
  
  @@map("ProductVariant") // 對應 CSV 表名
}

// 活動-商品 關聯表
model EventsProducts {
  event_id   Int
  product_id Int
  
  // (未來關聯：活動)
  // event   Event   @relation(fields: [event_id], references: [id])
  // (關聯：商品)
  product Product @relation(fields: [product_id], references: [id])
  
  @@id([event_id, product_id]) // 複合主鍵
  @@map("events_products") // 對應 CSV 表名
}


// --- 2. 購物車 (Carts) ---

model Cart {
  id         Int       @id @default(autoincrement())
  user_id    Int       @unique // (未來關聯 User(id))
  updated_at DateTime? @updatedAt

  // 關聯：一個購物車有多個項目
  items CartItem[]
  
  // (未來關聯：使用者)
  // user    User    @relation(fields: [user_id], references: [id])

  @@map("Cart") // 對應 CSV 表名
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cart_id   Int
  cart      Cart     @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  item_type ItemType // ENUM('ticket_types', 'products')

  // (未來關聯：票種)
  ticket_type_id Int?

  // (關聯：商品規格)
  product_variant_id Int?
  product_variant    ProductVariant? @relation(fields: [product_variant_id], references: [id])

  quantity Int
  added_at DateTime @default(now())

  @@map("CartItem") // 對應 CSV 表名
}


// --- 3. 結帳 (Orders) ---

model Order {
  id              Int       @id @default(autoincrement())
  order_number    String    @unique @db.VarChar(50)
  user_id         Int       // (未來關聯 User(id))
  
  subtotal        Decimal   @db.Decimal(10, 2)
  discount_amount Decimal   @default(0) @db.Decimal(10, 2)
  total_amount    Decimal   @db.Decimal(10, 2)
  
  coupon_id       Int?      // (未來關聯 Coupon(id))
  coupon_code     String?   @db.VarChar(50)
  
  status          OrderStatus @default(pending)
  
  billing_name    String    @db.VarChar(100)
  billing_phone   String    @db.VarChar(20)
  billing_address String?   @db.Text
  
  payment_method  String?   @db.VarChar(50)
  created_at      DateTime  @default(now())
  expires_at      DateTime

  // 關聯：一個訂單有多個項目
  items OrderItem[]
  
  // (未來關聯：使用者)
  // user          User     @relation(fields: [user_id], references: [id])
  
  @@map("Order") // 對應 CSV 表名
}

model OrderItem {
  id                  Int      @id @default(autoincrement())
  order_id            Int
  order               Order    @relation(fields: [order_id], references: [id], onDelete:Cascade)
  item_type           ItemType
  // (未來關聯：票種)
  ticket_type_id      Int? 
  // (關聯：商品規格)
  product_variant_id Int?
  product_variant     ProductVariant? @relation(fields: [product_variant_id], references: [id])
  // (快照)
  item_name           String   @db.VarChar(255)
  variant_description String?  @db.VarChar(100)
  quantity            Int
  unit_price          Decimal  @db.Decimal(10, 2)
  delivery_method     DeliveryMethod?

  // (未來關聯：電子票券)
  // tickets             Ticket[]

  // (新增) 關聯：一個訂單項目對應一筆報名資料
  ticket_registration TicketRegistration?

  @@map("OrderItem") // 對應 CSV 表名
}

//票券報名資料
model TicketRegistration {
  id           Int    @id @default(autoincrement())
  order_item_id Int    @unique // (重要) 關聯到訂單項目 (一對一)
  order_item    OrderItem @relation(fields: [order_item_id], references: [id], onDelete: Cascade)
  // (未來關聯：票券)
  ticket_id     Int?   @unique
  // (報名者資料，來自 CSV)
  name          String @db.VarChar(100)
  email         String @db.VarChar(255)
  phone         String @db.VarChar(20)

  @@map("Ticket_Registration") // 對應 CSV 表名
}

model contact_tags {
  id   Int    @id @default(autoincrement())
  name String
}

model post_category {
  id       Int        @id @default(autoincrement())
  name     String
  userpost userpost[]
}

model post_comments {
  id         Int                  @id @default(autoincrement())
  content    String
  rating     post_comments_rating
  created_at DateTime
  post_id    Int
  authorId   Int
  users      users                @relation(fields: [authorId], references: [id])
  userpost   userpost             @relation(fields: [post_id], references: [id])

  @@index([authorId], map: "post_comments_authorId_fkey")
  @@index([post_id], map: "post_comments_post_id_fkey")
}

model post_images {
  id        Int      @id @default(autoincrement())
  postId    Int
  imageUrl  String   @db.VarChar(255)
  isCover   Boolean  @default(false)
  createdAt DateTime @default(now())
  userpost  userpost @relation(fields: [postId], references: [id])

  @@index([postId], map: "post_images_postId_fkey")
}

model post_tags {
  id   Int    @id @default(autoincrement())
  name String
}

model userpost {
  id            Int             @id @default(autoincrement())
  authorId      Int
  title         String          @db.VarChar(150)
  content       String
  categoryId    Int
  status        userpost_status @default(pending)
  createdAt     DateTime        @default(now())
  publishedAt   DateTime?
  articleId     Int?
  post_comments post_comments[]
  post_images   post_images[]
  users         users           @relation(fields: [authorId], references: [id], map: "UserPost_authorId_fkey")
  post_category post_category   @relation(fields: [categoryId], references: [id], map: "UserPost_categoryId_fkey")

  @@index([authorId], map: "UserPost_authorId_fkey")
  @@index([categoryId], map: "UserPost_categoryId_fkey")
}

model users {
  id            Int             @id @default(autoincrement())
  name          String?
  post_comments post_comments[]
  userpost      userpost[]
}

enum post_comments_rating {
  one
  two
  three
  four
  five
}

enum userpost_status {
  pending
  approved
  rejected
}
