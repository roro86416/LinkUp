generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- 模組一 : 登入註冊 (Users) ---

// =======================
// Users 主帳號表
// =======================
model User {
  id                     Int       @id @default(autoincrement())
  email                  String?   @unique
  password_hash          String?
  role                   UserRole
  is_active              Boolean   @default(true)
  password_reset_token   String?
  password_reset_expires DateTime?
  name                   String
  avatar                 String?
  phone_number           String?
  birth_date             DateTime?
  address                String?

  notifications UserNotificationStatus[]
  reviews       Review[]
  userProviders UserProvider[]
  userFavorites UserFavorite[]

  created_at DateTime   @default(now())
  updated_at DateTime   @updatedAt
  Organizer  Organizer?
}

enum UserRole {
  MEMBER
  ORGANIZER
}

// =======================
// Notifications 通知表
// =======================
model Notification {
  id              Int                    @id @default(autoincrement())
  template_id     Int?
  template        NotificationTemplate?  @relation(fields: [template_id], references: [id])
  sender_admin_id Int?
  target_type     NotificationTargetType
  target_id       Int?
  type            NotificationType
  title           String
  message         String
  link_url        String?
  sent_at         DateTime?
  created_at      DateTime               @default(now())
  updated_at      DateTime               @updatedAt

  userStatuses UserNotificationStatus[]
}

enum NotificationTargetType {
  USER
  ORGANIZER
  ALL
}

enum NotificationType {
  system
  event
  transaction
  review
  announcement
}

// =======================
// 使用者通知狀態
// =======================
model UserNotificationStatus {
  id              Int          @id @default(autoincrement())
  notification    Notification @relation(fields: [notification_id], references: [id])
  notification_id Int
  user            User         @relation(fields: [user_id], references: [id])
  user_id         Int
  is_read         Boolean      @default(false)
  read_at         DateTime?
  is_deleted      Boolean      @default(false)
  deleted_at      DateTime?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
}

// =======================
// 通知模板表
// =======================
model NotificationTemplate {
  id           Int              @id @default(autoincrement())
  title        String
  message      String
  type         NotificationType
  target_role  UserRole
  is_active    Boolean          @default(true)
  scheduled_at DateTime?
  created_by   Int?
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt
  Notification Notification[]
}

// =======================
// Reviews 審核表
// =======================
model Review {
  id          Int              @id @default(autoincrement())
  target_type ReviewTargetType
  target_id   Int?
  status      ReviewStatus     @default(PENDING)
  reviewed_by Int?
  reviewed_at DateTime?
  reason      String?
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
  User        User?            @relation(fields: [userId], references: [id])
  userId      Int?
}

enum ReviewTargetType {
  ORGANIZER
  EVENT
  USER_POST
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// =======================
// 第三方登入綁定表
// =======================
model UserProvider {
  id            Int          @id @default(autoincrement())
  user          User         @relation(fields: [user_id], references: [id])
  user_id       Int
  provider      AuthProvider
  provider_id   String
  access_token  String?
  refresh_token String?
  linked_at     DateTime
  is_primary    Boolean      @default(false)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  @@unique([provider, provider_id])
}

enum AuthProvider {
  GOOGLE
  FACEBOOK
}

// =======================
// 收藏表
// =======================
model UserFavorite {
  id               Int          @id @default(autoincrement())
  user             User         @relation(fields: [user_id], references: [id])
  user_id          Int
  favoritable_id   Int
  favoritable_type FavoriteType
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
}

enum FavoriteType {
  EVENT
  USER_POST
  ORGANIZER
}

// =======================
// Admin 管理員表
// =======================
model Admin {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  password_hash String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

// =======================
// Announcements 系統公告表
// =======================
model Announcement {
  id            Int      @id @default(autoincrement())
  title         String
  subtitle      String?
  content       String
  link_url      String?
  start_date    DateTime
  end_date      DateTime
  display_order Int      @default(0)
  is_active     Boolean  @default(true)
  created_by    Int?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  images AnnouncementImage[]
}

model AnnouncementImage {
  id              Int          @id @default(autoincrement())
  announcement    Announcement @relation(fields: [announcement_id], references: [id])
  announcement_id Int
  image_url       String
  is_cover        Boolean      @default(false)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
}

// =======================
// Organizers 主辦方表
// =======================
model Organizer {
  id              Int      @id @default(autoincrement())
  user_id         Int?     @unique
  user            User?    @relation(fields: [user_id], references: [id])
  org_name        String?
  org_address     String?
  org_phone       String?
  org_tax_id      String?
  org_description String?
  is_verified     Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}

// --- 模組三：相關的枚舉 (Enums) ---

// 訂單狀態 (來自 Order 表)
enum OrderStatus {
  pending // 待付款
  paid // 已付款
  shipped // (商品) 已出貨
  completed // (流程) 已完成
  cancelled // 已取消
}

// 項目類型 (來自 CartItem / OrderItem 表)
enum ItemType {
  ticket_types // 票券
  products // 商品
}

// (商品) 運送方式 (來自 OrderItem 表)
enum DeliveryMethod {
  shipping // 宅配
  on_site_pickup // 現場取貨
}

// --- 1. 商城 (Products) ---
// 商品
model Product {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(255) /// 商品名稱
  description String? @db.Text /// 商品描述
  base_price  Decimal @db.Decimal(10, 2) /// 商品基本價格
  image_url   String? @db.VarChar(255) /// 商品圖片

  // 關聯：一個商品有多個規格
  variants ProductVariant[]

  // 關聯：活動-商品 多對多
  events_products EventsProducts[]

  @@map("products") // 對應 CSV 表名
}

// 商品規格
model ProductVariant {
  id         Int     @id @default(autoincrement()) /// 規格 ID
  product_id Int
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  sku           String? @unique @db.VarChar(100)
  option1_name  String? @db.VarChar(50)
  option1_value String? @db.VarChar(50)
  option2_name  String? @db.VarChar(50)
  option2_value String? @db.VarChar(50)

  price_offset   Decimal @default(0) @db.Decimal(10, 2)
  stock_quantity Int     @default(0) @map("stock") // CSV 中欄位名為 stock

  // 關聯：此規格在哪些購物車項目中
  cart_items  CartItem[]
  // 關聯：此規格在哪些訂單項目中
  order_items OrderItem[]

  @@map("ProductVariant") // 對應 CSV 表名
}

// 活動-商品 關聯表
model EventsProducts {
  event_id   Int
  product_id Int

  // (未來關聯：活動)
  // event   Event   @relation(fields: [event_id], references: [id])
  // (關聯：商品)
  product Product @relation(fields: [product_id], references: [id])

  @@id([event_id, product_id]) // 複合主鍵
  @@map("events_products") // 對應 CSV 表名
}

// --- 2. 購物車 (Carts) ---

model Cart {
  id         Int       @id @default(autoincrement())
  user_id    Int       @unique // (未來關聯 User(id))
  updated_at DateTime? @updatedAt

  // 關聯：一個購物車有多個項目
  items CartItem[]

  // (未來關聯：使用者)
  // user    User    @relation(fields: [user_id], references: [id])

  @@map("Cart") // 對應 CSV 表名
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cart_id   Int
  cart      Cart     @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  item_type ItemType // ENUM('ticket_types', 'products')

  // (未來關聯：票種)
  ticket_type_id Int?

  // (關聯：商品規格)
  product_variant_id Int?
  product_variant    ProductVariant? @relation(fields: [product_variant_id], references: [id])

  quantity Int
  added_at DateTime @default(now())

  @@map("CartItem") // 對應 CSV 表名
}

// --- 3. 結帳 (Orders) ---

model Order {
  id           Int    @id @default(autoincrement())
  order_number String @unique @db.VarChar(50)
  user_id      Int // (未來關聯 User(id))

  subtotal        Decimal @db.Decimal(10, 2)
  discount_amount Decimal @default(0) @db.Decimal(10, 2)
  total_amount    Decimal @db.Decimal(10, 2)

  coupon_id   Int? // (未來關聯 Coupon(id))
  coupon_code String? @db.VarChar(50)

  status OrderStatus @default(pending)

  billing_name    String  @db.VarChar(100)
  billing_phone   String  @db.VarChar(20)
  billing_address String? @db.Text

  payment_method String?  @db.VarChar(50)
  created_at     DateTime @default(now())
  expires_at     DateTime

  // 關聯：一個訂單有多個項目
  items OrderItem[]

  // (未來關聯：使用者)
  // user          User     @relation(fields: [user_id], references: [id])

  @@map("Order") // 對應 CSV 表名
}

model OrderItem {
  id                  Int             @id @default(autoincrement())
  order_id            Int
  order               Order           @relation(fields: [order_id], references: [id], onDelete: Cascade)
  item_type           ItemType
  // (未來關聯：票種)
  ticket_type_id      Int?
  // (關聯：商品規格)
  product_variant_id  Int?
  product_variant     ProductVariant? @relation(fields: [product_variant_id], references: [id])
  // (快照)
  item_name           String          @db.VarChar(255)
  variant_description String?         @db.VarChar(100)
  quantity            Int
  unit_price          Decimal         @db.Decimal(10, 2)
  delivery_method     DeliveryMethod?

  // (未來關聯：電子票券)
  // tickets             Ticket[]

  // (新增) 關聯：一個訂單項目對應一筆報名資料
  ticket_registration TicketRegistration?

  @@map("OrderItem") // 對應 CSV 表名
}

//票券報名資料
model TicketRegistration {
  id            Int       @id @default(autoincrement())
  order_item_id Int       @unique // (重要) 關聯到訂單項目 (一對一)
  order_item    OrderItem @relation(fields: [order_item_id], references: [id], onDelete: Cascade)
  // (未來關聯：票券)
  ticket_id     Int?      @unique
  // (報名者資料，來自 CSV)
  name          String    @db.VarChar(100)
  email         String    @db.VarChar(255)
  phone         String    @db.VarChar(20)

  @@map("Ticket_Registration") // 對應 CSV 表名
}
