generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------
// 專案共用的枚舉 (Enums)
// -------------------------------------------------

// --- 模組三：的枚舉 ---
enum OrderStatus {
  pending
  paid
  shipped
  completed
  cancelled
}

enum ItemType {
  ticket_types
  products
}

enum DeliveryMethod {
  shipping
  on_site_pickup
}

// --- 模組二 & 四 的枚舉 ---
enum EventStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  OFFLINE
  ONLINE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CheckInStatus {
  SUCCESS
  DUPLICATE
  INVALID
}

enum TicketStatus {
  VALID
  USED
  EXPIRED
  CANCELLED
}

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

// -------------------------------------------------
// 模組一：共用模型 (User)
// -------------------------------------------------
model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String?
  role  UserRole @default(USER)

  organizedEvents Event[] @relation("OrganizedBy")
  cart    Cart?
  orders  Order[]
  scannedLogs CheckIn[] @relation("ScannedBy")
  tickets     Ticket[]  @relation("OwnedBy")

  Review Review[]
}

// -------------------------------------------------
// 模組二：的依賴模型
// -------------------------------------------------
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  parentId  Int?      @map("parent_id")
  parent    Category? @relation("CategoryParent", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryParent")
  events    Event[]

  @@map("categories")
  @@index([parentId])
}


model Tag {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  events Event[] @relation("EventTags")
}

// -------------------------------------------------
// 模組三：商城 (Products) 
// -------------------------------------------------
model Product {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  base_price  Decimal  @db.Decimal(10, 2)
  image_url   String?  @db.VarChar(255)
  variants    ProductVariant[]
  
  events_products EventsProducts[]

  @@map("products")
}

model ProductVariant {
  id               Int      @id @default(autoincrement())
  product_id       Int
  product          Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  sku              String?  @unique @db.VarChar(100)
  option1_name     String?  @db.VarChar(50)
  option1_value    String?  @db.VarChar(50)
  option2_name     String?  @db.VarChar(50)
  option2_value    String?  @db.VarChar(50)
  price_offset     Decimal  @default(0) @db.Decimal(10, 2)
  stock_quantity   Int      @default(0) @map("stock")
  cart_items       CartItem[]
  order_items      OrderItem[]

  @@map("ProductVariant")
}

model EventsProducts {
  event_id   Int
  product_id Int
  
  event   Event   @relation(fields: [event_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@id([event_id, product_id])
  @@map("events_products")
}

// -------------------------------------------------
// 模組三：購物車 (Carts) 
// -------------------------------------------------
model Cart {
  id         Int       @id @default(autoincrement())
  user_id    Int       @unique
  updated_at DateTime? @updatedAt
  items      CartItem[]

  user User @relation(fields: [user_id], references: [id])

  @@map("Cart")
}

model CartItem {
  id           Int      @id @default(autoincrement())
  cart_id      Int
  cart         Cart     @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  item_type    ItemType
  quantity     Int
  added_at     DateTime @default(now())

  ticket_type_id Int?
  ticket_type    TicketType? @relation(fields: [ticket_type_id], references: [id])

  product_variant_id Int?
  product_variant    ProductVariant? @relation(fields: [product_variant_id], references: [id])

  @@map("CartItem")
}

// -------------------------------------------------
// 模組三：結帳 (Orders)
// -------------------------------------------------
model Order {
  id              Int         @id @default(autoincrement())
  order_number    String      @unique @db.VarChar(50)
  user_id         Int
  subtotal        Decimal     @db.Decimal(10, 2)
  discount_amount Decimal     @default(0) @db.Decimal(10, 2)
  total_amount    Decimal     @db.Decimal(10, 2)
  coupon_code     String?     @db.VarChar(50)
  status          OrderStatus @default(pending)
  billing_name    String      @db.VarChar(100)
  billing_phone   String      @db.VarChar(20)
  billing_address String?     @db.Text
  payment_method  String?     @db.VarChar(50)
  created_at      DateTime    @default(now())
  expires_at      DateTime
  items           OrderItem[]

  user User @relation(fields: [user_id], references: [id])

  coupon_id Int?
  coupon    Coupon? @relation(fields: [coupon_id], references: [id])

  @@map("Order")
}

model OrderItem {
  id                  Int      @id @default(autoincrement())
  order_id            Int
  order               Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  item_type           ItemType
  item_name           String   @db.VarChar(255)
  variant_description String?  @db.VarChar(100)
  quantity            Int
  unit_price          Decimal  @db.Decimal(10, 2)
  delivery_method     DeliveryMethod?

  ticket_type_id Int?
  ticket_type    TicketType? @relation(fields: [ticket_type_id], references: [id])

  product_variant_id Int?
  product_variant    ProductVariant? @relation(fields: [product_variant_id], references: [id])

  ticket_registration TicketRegistration?

  @@map("OrderItem")
}

model TicketRegistration {
  id            Int       @id @default(autoincrement())
  order_item_id Int       @unique
  order_item    OrderItem @relation(fields: [order_item_id], references: [id], onDelete: Cascade)
  // (未來關聯：票券)
  ticket_id     Int?   @unique
  // (報名者資料，來自 CSV)
  name          String @db.VarChar(100)
  email         String @db.VarChar(255)
  phone         String @db.VarChar(20)

  @@map("Ticket_Registration") // 對應 CSV 表名
}

model contact_tags {
  id   Int    @id @default(autoincrement())
  name String
}

model post_category {
  id       Int        @id @default(autoincrement())
  name     String
  userpost userpost[]
}

model post_comments {
  id         Int                  @id @default(autoincrement())
  content    String
  rating     post_comments_rating
  created_at DateTime
  post_id    Int
  authorId   Int
  users      users                @relation(fields: [authorId], references: [id])
  userpost   userpost             @relation(fields: [post_id], references: [id])

  @@index([authorId], map: "post_comments_authorId_fkey")
  @@index([post_id], map: "post_comments_post_id_fkey")
}

model post_images {
  id        Int      @id @default(autoincrement())
  postId    Int
  imageUrl  String   @db.VarChar(255)
  isCover   Boolean  @default(false)
  createdAt DateTime @default(now())
  userpost  userpost @relation(fields: [postId], references: [id])

  @@index([postId], map: "post_images_postId_fkey")
}

model post_tags {
  id   Int    @id @default(autoincrement())
  name String
}

model userpost {
  id            Int             @id @default(autoincrement())
  authorId      Int
  title         String          @db.VarChar(150)
  content       String
  categoryId    Int
  status        userpost_status @default(pending)
  createdAt     DateTime        @default(now())
  publishedAt   DateTime?
  articleId     Int?
  post_comments post_comments[]
  post_images   post_images[]
  users         users           @relation(fields: [authorId], references: [id], map: "UserPost_authorId_fkey")
  post_category post_category   @relation(fields: [categoryId], references: [id], map: "UserPost_categoryId_fkey")

  @@index([authorId], map: "UserPost_authorId_fkey")
  @@index([categoryId], map: "UserPost_categoryId_fkey")
}

model users {
  id            Int             @id @default(autoincrement())
  name          String?
  post_comments post_comments[]
  userpost      userpost[]
}

enum post_comments_rating {
  one
  two
  three
  four
  five
}

enum userpost_status {
  pending
  approved
  rejected
}
